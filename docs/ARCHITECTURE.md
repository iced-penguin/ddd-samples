# アーキテクチャガイド

## ポートとアダプターアーキテクチャ

本システムは、ポートとアダプターアーキテクチャ（ヘキサゴナルアーキテクチャ）を採用した書籍注文管理システムです。

### アーキテクチャ概要

```
┌─────────────────────────────────┐
│      アダプター（駆動側）        │
│   - REST API                    │
└────────────┬────────────────────┘
             │
             ↓ 入力ポート
┌─────────────────────────────────┐
│      アプリケーション層          │
│   - アプリケーションサービス     │
└────────────┬────────────────────┘
             │
             ↓
┌─────────────────────────────────┐
│         ドメイン層               │
│   - 集約                        │
│   - 値オブジェクト               │
│   - ドメインイベント             │
│   - ドメインサービス             │
│   - 出力ポート（リポジトリ、イベント発行者）│
└────────────┬────────────────────┘
             │
             ↓ 出力ポート
┌─────────────────────────────────┐
│      アダプター（駆動される側）  │
│   - リポジトリの実装               │
│   - イベント発行者の実装           │
└────────────┬────────────────────┘
             │
             ↓
┌─────────────────────────────────┐
│      インフラストラクチャ        │
│   - データベース                 │
│   - メッセージング               │
│   - コンテナ環境                 │
└─────────────────────────────────┘
```

### 各層の責務

#### ドメイン層（中心）
- **責務**: 書籍注文管理のビジネスロジックとルールの実装
- **特徴**: 外部の技術的詳細に依存しない
- **構成要素**:
  - **集約**: Order（注文）、Inventory（在庫）
  - **値オブジェクト**: OrderId, BookId, CustomerId, Money, OrderLine, ShippingAddress, OrderStatus
  - **ドメインイベント**: OrderConfirmed, OrderCancelled, OrderShipped, OrderDelivered
  - **ドメインサービス**: InventoryService: 在庫予約・解放）
  - **出力ポート**: OrderRepository, InventoryRepository, EventPublisher（トレイト）

#### アプリケーション層
- **責務**: 注文・在庫管理のユースケース調整とトランザクション管理
- **特徴**: ドメインオブジェクトを組み合わせて注文フローを実現
- **構成要素**:
  - **OrderApplicationService**: 注文作成、書籍追加、確定、キャンセル、発送、配達完了
  - **OrderQueryService**: 注文の検索・取得
  - **InventoryQueryService**: 在庫の検索・取得

#### アダプター層
- **責務**: 外部世界とドメイン層の橋渡し
- **駆動側アダプター**: アプリケーションを起動
  - REST APIコントローラー: 注文・在庫管理エンドポイント
- **駆動される側アダプター**: ドメインから呼び出される
  - MySqlOrderRepository: 注文データの永続化
  - MySqlInventoryRepository: 在庫データの永続化
  - ConsoleEventPublisher: ドメインイベント発行

## 依存性の方向

### 依存性逆転の原則

```
外部世界 → アダプター → アプリケーション → ドメイン
                                    ↑
                              ポート（trait）
```

- **すべての依存性はドメイン層に向かう**
- **ドメイン層は外部に依存しない**
- **アダプター層がドメイン層の定義するポートを実装**

## 設計原則

### SOLID原則の適用

1. **単一責任原則 (SRP)**: 各モジュールは単一の責任を持つ
   - Order集約は注文管理のみ
   - Inventory集約は在庫管理のみ
   - InventoryServiceは在庫予約・解放のみ

2. **開放閉鎖原則 (OCP)**: 拡張に開いて、修正に閉じている
   - 新しいEventPublisher実装（例：メール通知）を追加可能
   - 新しいRepository実装（例：PostgreSQL）を追加可能

3. **リスコフ置換原則 (LSP)**: 実装は抽象化と置換可能
   - MySqlOrderRepositoryはOrderRepositoryトレイトと置換可能

4. **インターフェース分離原則 (ISP)**: 必要な機能のみを公開
   - OrderRepositoryとInventoryRepositoryを分離
   - QueryServiceとApplicationServiceを分離

5. **依存性逆転原則 (DIP)**: 高レベルモジュールは低レベルモジュールに依存しない
   - ドメイン層はアダプター層に依存しない
   - アプリケーション層はトレイト（ポート）に依存