# ドメイン駆動設計の学習ポイント

このプロジェクトを通じて、以下のDDDの主要概念を実践的に学ぶことができます：

## エンティティと値オブジェクト

### エンティティ（Entity）

**Order（注文）**
- 一意の識別子（OrderId）を持つ
- ライフサイクル全体を通じて同一性を保つ
- 状態変更可能（ミュータブル）
- ビジネスロジックをカプセル化

**Inventory（在庫）**
- 書籍IDで識別される
- 在庫数の変更を管理
- 予約・解放の操作を提供

### 値オブジェクト（Value Object）

**識別子系**
- `OrderId`, `BookId`, `CustomerId`: 型安全な識別子

**ビジネス概念**
- `Money`: 金額と通貨を持つ不変オブジェクト
- `OrderLine`: 注文明細（書籍ID、数量、単価）
- `ShippingAddress`: 配送先住所（バリデーション付き）
- `OrderStatus`: 注文ステータス（列挙型）

### 学習ポイント

- **同一性 vs 等価性**: エンティティは識別子で比較、値オブジェクトは値で比較
- **不変性**: 値オブジェクトは作成後変更不可
- **ビジネスルールのカプセル化**: 値オブジェクト内でバリデーションを実装
- **型安全性**: Rustの型システムを活用した不正値の排除

## 集約（Aggregate）

### Order Aggregate（注文集約）

**集約ルート**: `Order`

**不変条件**:
- 注文には少なくとも1つの注文明細が必要（確定時）
- 配送先住所は確定時に必須
- ステータス遷移は定義されたルールに従う
- 同じ書籍の注文明細は1つのみ（数量で管理）

**操作**:
- 書籍の追加・削除
- 配送先住所の設定
- ステータス遷移（確定、キャンセル、発送、配達完了）

### Inventory Aggregate（在庫集約）

**集約ルート**: `Inventory`

**不変条件**:
- 在庫数は常に0以上
- 予約数は在庫数を超えない
- 利用可能数 = 在庫数 - 予約数

**操作**:
- 在庫の予約・解放
- 在庫数の更新

### 学習ポイント

- **トランザクション境界**: 集約単位でデータ整合性を保証
- **不変条件の保護**: 集約ルートを通じてのみ状態変更
- **集約間の参照**: IDによる参照（オブジェクト参照は避ける）
- **サイズの考慮**: 集約は適切なサイズに保つ

## ドメインイベント（Domain Event）

### 発行されるイベント

- `OrderConfirmed`: 注文確定時
- `OrderCancelled`: 注文キャンセル時
- `OrderShipped`: 注文発送時
- `OrderDelivered`: 注文配達完了時

### イベントの特徴

- **不変性**: 一度作成されたら変更不可
- **過去形命名**: 発生した事実を表現
- **豊富な情報**: イベント処理に必要な情報を含む
- **タイムスタンプ**: 発生時刻を記録

### 学習ポイント

- **結果整合性**: イベントを通じた非同期処理
- **システム統合**: 他のバウンデッドコンテキストとの連携
- **監査ログ**: ビジネスイベントの履歴管理
- **副作用の分離**: メインロジックと副作用の分離

## リポジトリパターン（Repository Pattern）

### ドメイン層/出力ポート（トレイト）

- `OrderRepository`
- `InventoryRepository`

### アダプター（実装）

- `MySqlOrderRepository`
- `MySqlInventoryRepository`

### 学習ポイント

- **抽象化**: 永続化の詳細をドメイン層から隠蔽
- **依存性逆転**: ドメイン層がインターフェース（トレイトが該当）を定義
- **テスタビリティ**: モック実装による単体テスト
- **技術非依存**: データベース変更時のドメイン層への影響なし

## ドメインサービス（Domain Service）

### InventoryService

複数の集約（OrderとInventory）にまたがるロジックを実装：

- 注文確定時の在庫予約
- 注文キャンセル時の在庫解放
- 在庫不足チェック

### 学習ポイント

- **集約横断ロジック**: 単一集約に属さないドメインロジック
- **ステートレス**: 状態を持たないサービス
- **ドメイン知識**: 技術的でなくビジネス的な処理
- **協調処理**: 複数の集約を協調させる
